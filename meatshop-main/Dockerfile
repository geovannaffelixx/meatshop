# ============================================
# ðŸ§© STAGE 1 â€” BUILD (Next.js)
# ============================================
FROM node:20-alpine AS builder

# DependÃªncia mÃ­nima para pacotes binÃ¡rios (ex: sharp)
RUN apk add --no-cache libc6-compat

WORKDIR /usr/src/app

# Copia apenas arquivos necessÃ¡rios para dependÃªncias
COPY package*.json ./

# Instala dependÃªncias completas (dev + build)
RUN npm ci

# Copia todo o cÃ³digo-fonte
COPY . .

# Injetar variÃ¡vel pÃºblica no build
ARG NEXT_PUBLIC_API_URL
ENV NEXT_PUBLIC_API_URL=${NEXT_PUBLIC_API_URL}

# Gera build otimizado do Next.js
RUN echo "ðŸ“¦ Building with NEXT_PUBLIC_API_URL=${NEXT_PUBLIC_API_URL}" && npm run build

# ðŸ”¥ Limpa cache e node_modules (para imagem menor)
RUN rm -rf node_modules && npm cache clean --force && rm -rf .next/cache

# ============================================
# ðŸš€ STAGE 2 â€” RUNTIME (produÃ§Ã£o)
# ============================================
FROM node:20-alpine AS runtime

WORKDIR /usr/src/app

# Copia apenas manifestos
COPY package*.json ./

# Instala dependÃªncias de produÃ§Ã£o
RUN npm ci --omit=dev && npm cache clean --force

# Copia build otimizado do estÃ¡gio anterior
COPY --from=builder /usr/src/app/.next ./.next
COPY --from=builder /usr/src/app/public ./public
COPY --from=builder /usr/src/app/package*.json ./

# Define usuÃ¡rio nÃ£o root (seguranÃ§a)
USER node

# VariÃ¡veis padrÃ£o
ENV NODE_ENV=production \
    PORT=3000 \
    NEXT_TELEMETRY_DISABLED=1 \
    TZ=America/Sao_Paulo

EXPOSE 3000

# Volume opcional para logs
VOLUME ["/usr/src/app/logs"]

# Inicializa servidor Next
CMD ["npm", "start"]
