# ============================================
# ðŸ§© STAGE 1 â€” BUILD
# ============================================
FROM node:20-alpine AS builder

WORKDIR /usr/src/app

# Copia apenas os arquivos de dependÃªncias primeiro (melhor cache)
COPY package*.json ./

# Instala dependÃªncias (incluindo dev)
RUN npm ci

# Copia todo o cÃ³digo-fonte
COPY . .

# Gera o build de produÃ§Ã£o do Next.js
RUN npm run build


# ============================================
# ðŸš€ STAGE 2 â€” PRODUÃ‡ÃƒO
# ============================================
FROM node:20-alpine

WORKDIR /usr/src/app

# Copia apenas o resultado final (build estÃ¡tico e configs)
COPY --from=builder /usr/src/app/.next ./.next
COPY --from=builder /usr/src/app/public ./public
COPY --from=builder /usr/src/app/package*.json ./

# Instala sÃ³ dependÃªncias de produÃ§Ã£o
RUN npm ci --omit=dev

# Define variÃ¡veis de ambiente padrÃ£o (pode ser sobrescrito no docker-compose)
ENV NODE_ENV=production \
    PORT=3000 \
    NEXT_TELEMETRY_DISABLED=1 \
    TZ=America/Sao_Paulo

EXPOSE 3000

# Comando de inicializaÃ§Ã£o
CMD ["npm", "start"]
